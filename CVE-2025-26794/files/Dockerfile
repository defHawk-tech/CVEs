FROM debian

RUN apt-get update
RUN apt-get install -y gcc net-tools vim gdb python3 wget git make procps libpcre3-dev libdb-dev libxt-dev libxaw7-dev  libpcre2-dev libssl-dev nano  libsqlite3-dev sqlite3 telnet pkg-config
RUN cpan install File::FcntlLock

RUN useradd -ms /bin/bash exim-demo

RUN git clone https://github.com/Exim/exim.git

## Checkout latest version
RUN cd exim && git checkout exim-4.98 && cd src && mkdir -p Local && cp src/EDITME Local/Makefile && cp exim_monitor/EDITME Local/eximon.conf

WORKDIR /exim/src
RUN sed -i 's/^EXIM_USER=.*$/EXIM_USER=exim-demo/' Local/Makefile
RUN sed -i 's/^#\s*\(AUTH_PLAINTEXT=yes\)/\1/' Local/Makefile

# Add debug flags
RUN sed -i 's/CFLAGS ?= -O\b/CFLAGS ?= -Og -g/' OS/Makefile-Linux

RUN sed -i 's/^#\s*\(USE_OPENSSL=yes\)/\1/' Local/Makefile
RUN sed -i 's/^#\s*\(USE_OPENSSL_PC=openssl\)/\1/' Local/Makefile
## Add SQLITE Support
RUN sed -i 's/^#\s*\(USE_SQLITE = yes\)/\1/' Local/Makefile
RUN echo "DBMLIB = -lsqlite3"  >> Local/Makefile

RUN make makefile

RUN make install

COPY start-exim.sh .

# runtime config
COPY configure /usr/exim/configure


