# Overview of CVE-2025-26794

CVE-2025-26794 is a critical SQL injection vulnerability affecting Exim Mail Server, specifically impacting version 4.98. The vulnerability is in the `hintsdb.h` file (now relocated to `hints_sqlite.h` in newer versions) and is related to Exim’s SQLite-based hints database used with ETRN serialization. Due to unsafe SQL query handling, remote attackers can craft malicious ETRN requests (ETRN request is a command that instructs a mail server to deliver all emails for a domain to another SMTP server.) to execute unauthorized SQL commands, potentially compromising the mail server’s database and overall integrity.

## Root Cause of the Vulnerability

### Unvalidated User Input in SQL Queries
- The system concatenated user input directly into SQL statements without proper sanitization, allowing attackers to manipulate the database.
- Specifically, ETRN requests were processed without adequate filtering, opening the door for SQL injection.

### Unsafe String Handling & Memory Mismanagement
- Improper string termination checks allowed malformed keys to be processed.
- Dynamic memory allocations lacked boundary checks, increasing the risk of buffer overflows and segmentation faults.

### Direct Execution of Unescaped SQL Queries
- Functions like `sqlite3_exec` and `sprintf` were used with user-supplied data without escaping or parameterization.
- The function `exim_s_dbp` was particularly implicated in this issue.

## Exploitation Vector

Attackers could manipulate ETRN commands to inject SQL code. Example payload:

```sql
ETRN #',1); ## INSERT SQL HERE ## /*
```

This exploit allowed arbitrary SQL execution, which could lead to unauthorized data modification, credential theft, or full database compromise.

## Security Fixes Implemented

To mitigate CVE-2025-26794, Exim maintainers introduced the following security patches:

### Introduction of Parameterized Queries
- Replaced vulnerable string concatenation with prepared statements (`sqlite3_prepare_v2`).
- Used `sqlite3_bind_text` to securely insert user input instead of direct interpolation.

### Stricter String Handling
- Introduced a new function `is_cstring()` to validate key integrity before processing.
- Ensured all input keys are null-terminated to prevent buffer overflows.

### Enhanced Memory Safety
- Explicitly checked all memory allocations before use.
- Removed unsafe `malloc` and `memcpy` operations that could cause segmentation faults.

### Secure Query Execution
- Eliminated `sqlite3_exec` calls in favor of safer, bound execution methods.
- Introduced explicit NULL checking for SQL statements to prevent unexpected crashes.

## Mitigation Measures

### Immediate Upgrade
- Users should update to Exim version 4.98.1 or later, where this vulnerability has been addressed.

### Configuration Review
- Ensure the setting `acl_smtp_etrn` is set to `'deny'` unless ETRN functionality is explicitly required.
- Verify `smtp_etrn_serialize` is correctly configured to prevent unauthorized access.

## Impact of the Fixes

- SQL Injection risks were eliminated, preventing unauthorized database manipulation.
- Memory safety was significantly improved, reducing the likelihood of buffer overflows and crashes.
- Debugging capabilities were enhanced, allowing safer troubleshooting without exposing sensitive database queries.

## Conclusion

By addressing CVE-2025-26794, Exim’s maintainers have significantly hardened the security of its mail server database interactions, preventing attackers from leveraging SQL injection to compromise systems. These fixes ensure safer query execution, reinforce input validation, and reduce the risk of future vulnerabilities.

Organizations using Exim should immediately upgrade to a patched version and review their configurations to ensure continued security.
